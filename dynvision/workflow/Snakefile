include: "snake_utils.smk"
include: "snake_data.smk"
include: "snake_runtime.smk"
include: "snake_visualizations.smk"
include: "snake_experiments.smk"

SEED = ["1000", "1001", "1002"]

rule all:
    input:
        expand(project_paths.figures / "{experiment}" / "{experiment}_DyRCNNx8:tsteps=20+{categories}+dt=2+tau=5+tff=0+trc=6+tsk=0+lossrt=4_0040_imagenette_trained_all/dynamics_{focus_layer}.png",
            experiment=['duration', 'contrast', 'interval'],
            focus_layer=['V1', 'V2', 'V4', 'IT'],
            categories=['rctype=*+rctarget=output', 'rctype=full+rctarget=*']
            )

# ###############
# echo "Run all trainings and experiments"
# sh snakecharm.sh "rctarget"
# sh snakecharm.sh "rctype"
# sh snakecharm.sh "skip"
# sh snakecharm.sh "feedback --config batch_size=128"
# sh snakecharm.sh "tsteps"
# sh snakecharm.sh "lossrt"
# sh snakecharm.sh "idle"
# sh snakecharm.sh "timeparams"
# sh snakecharm.sh "stability --config test_batch_size=16"
# sh snakecharm.sh "unrolling --config batch_size=128"
# # sh snakecharm.sh "imagenet --config use_distributed_mode=True batch_size=512"
# # sh snakecharm.sh "dataloader"
# ###############

rule manuscript_figures:  # run with --allowed-rules process_test_data test_model
    input:
        expand(project_paths.figures / "{experiment}" / "{experiment}_DyRCNNx8:tsteps=20+{categories}+dt=2+tau=5+tff=0+trc=6+tsk=0+lossrt=4_0040_imagenette_trained_all/dynamics_{focus_layer}.png",
            experiment=['duration', 'contrast', 'interval'],
            focus_layer=['V1', 'V2', 'V4', 'IT'],
            categories=['rctype=*+rctarget=output', 'rctype=full+rctarget=*']
            )
    
rule idle:
    input:
        expand(project_paths.reports / "{experiment}" / "{experiment}_DyRCNNx8:tsteps=20+rctype=full+rctarget=output+dt=2+tau=5+tff=0+trc=6+tsk=0+skip=true+lossrt=4+idle=*_{seed}_imagenette_trained_all" / "test_data.csv",
            seed=SEED,
            experiment=['response'])

rule feedback:  # run with --config batch_size=128
    input:
        expand(project_paths.reports / "{experiment}" / "{experiment}_DyRCNNx8:tsteps=30+rctype=full+rctarget=output+dt=2+tau=5+tff=0+trc=6+tsk=0+tfb=30+skip=true+feedback=*+lossrt=4_{seed}_imagenette_trained_all" / "test_data.csv",
            seed=SEED,
            experiment=['response', 'responseffonly'])

rule skip:
    input:
        expand(project_paths.reports / "{experiment}" / "{experiment}_DyRCNNx8:tsteps=20+rctype=full+rctarget=output+dt=2+tau=5+tff=0+trc=6+tsk=0+skip=*+lossrt=4_{seed}_imagenette_trained_all" / "test_data.csv",
            seed=SEED,
            experiment=['response', 'responseffonly'])

rule tsteps:
    input:
        expand(project_paths.reports / "{experiment}" / "{experiment}_DyRCNNx8:tsteps=*+rctype=full+rctarget=output+dt=2+tau=5+tff=0+trc=6+tsk=0+skip=true+lossrt=4_{seed}_imagenette_trained_all" / "test_data.csv",
            seed=SEED,
            experiment=['response'])

rule lossrt:
    input:
        expand(project_paths.reports / "{experiment}" / "{experiment}_DyRCNNx8:tsteps=20+rctype=full+rctarget=output+dt=2+tau=5+tff=0+trc=6+tsk=0+skip=true+lossrt=*_{seed}_imagenette_trained_all" / "test_data.csv",
        seed=SEED,
        experiment=['response'])

rule rctarget:
    input:
        expand(project_paths.reports / "{experiment}" / "{experiment}_DyRCNNx8:tsteps=20+rctype=full+rctarget=*+dt=2+tau=5+tff=0+trc=6+tsk=0+skip=true+lossrt=4_{seed}_imagenette_trained_all" / "test_data.csv",
        seed=SEED,
        experiment=['responseffonly', 'response', 'uniformnoise', 'uniformnoiseffonly', 'poissonnoise', 'poissonnoiseffonly', 'gaussiannoise', 'gaussiannoiseffonly', 'gaussiancorrnoise', 'gaussiancorrnoiseffonly',]) 

rule rctype:
    input:
        expand(project_paths.reports / "{experiment}" / "{experiment}_DyRCNNx8:tsteps=20+rctype=*+rctarget=output+dt=2+tau=5+tff=0+trc=6+tsk=0+lossrt=4_{seed}_imagenette_trained_all" / "test_data.csv",
        seed=SEED,
        experiment=['response', 'duration', 'contrast', 'interval', 'responseffonly']),

rule timeparams:
    input:
        expand(project_paths.reports / "{experiment}" / "{experiment}_DyRCNNx8:tsteps=20+rctype=full+dt=2+tau=*+tff=0+trc=6+tsk=0+lossrt=4_{seed}_imagenette_trained_all" / "test_data.csv",
        seed=SEED,
        experiment=['response']),
        expand(project_paths.reports / "{experiment}" / "{experiment}_DyRCNNx8:tsteps=20+rctype=full+dt=2+tau=5+tff=0+trc=*+tsk=0+lossrt=4_{seed}_imagenette_trained_all" / "test_data.csv",
        seed=SEED,
        experiment=['response']),
        expand(project_paths.reports / "{experiment}" / "{experiment}_DyRCNNx8:tsteps=20+rctype=full+dt=2+tau=5+tff=0+trc=6+tsk=*+lossrt=4_{seed}_imagenette_trained_all" / "test_data.csv",
        seed=SEED,
        experiment=['response'])

rule stability:  # run with --config test_batch_size=16
    input:
        expand(project_paths.reports / "{experiment}" / "{experiment}_DyRCNNx8:tsteps=20+rctype=full+rctarget=*+dt=2+tau=5+tff=0+trc=6+tsk=0+skip=true+lossrt=4_{seed}_imagenette_trained_all" / "test_data.csv",
        seed=SEED,
        experiment=['stability']),
        expand(project_paths.reports / "{experiment}" / "{experiment}_DyRCNNx8:tsteps=20+rctype=*+rctarget=output+dt=2+tau=5+tff=0+trc=6+tsk=0+skip=true+lossrt=4_{seed}_imagenette_trained_all" / "test_data.csv",
        seed=SEED,
        experiment=['stability'])

rule unrolling:
    input:
        expand(project_paths.models / "DyRCNNx8" / "DyRCNNx8:tsteps=30+rctype=full+rctarget=output+dt=2+tau=5+tff=10+trc=6+tsk=20+tfb=10+skip=true+feedback=true+lossrt=4_{seed}_imagenette_trained.pt",
        seed=SEED,
        )

rule dataloader:
    input:
        expand(project_paths.figures / 'response' / 'response_DyRCNNx8:{configuration}_{seed}_imagenette_trained_all' / 'response.png',
        seed=SEED,
        configuration=[
            'tsteps=20+dataloader=ffcv+dsteps=1',
            'tsteps=20+dataloader=torch+dsteps=1',
            'tsteps=1+dataloader=ffcv+dsteps=20',
            'tsteps=1+dataloader=torch+dsteps=20',
        ]),

rule cornet:
    input:
        expand(project_paths.reports / "{experiment}" / "{experiment}_CorNetRT:dt=*_0000_imagenet_init_imagenette" / "test_data.csv",
        seed=SEED,
        experiment=['idleresponse'], #, 'duration', 'contrast', 'interval']
        )
        

rule imagenet:  # run with --config use_distributed_mode=True
    input:
        expand(project_paths.models / "DyRCNNx8" / "DyRCNNx8:tsteps=10+rctype=full+dt=2+tau=5+tff=0+trc=6+tsk=0+lossrt=4_{seed}_imagenet_trained.pt",
        seed=SEED,
        )
