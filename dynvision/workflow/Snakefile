include: "snake_utils.smk"
include: "snake_data.smk"
include: "snake_runtime.smk"
include: "snake_visualizations.smk"
include: "snake_experiments.smk"

rule all:
    input:
        expand(project_paths.reports / 'experiment_{experiment}.done',
            experiment = config.experiment)

SEED = "0040"

rule idle:
    input:
        expand(project_paths.reports / "{experiment}" / "{experiment}_DyRCNNx8:tsteps=20+rctype=full+rctarget=output+dt=2+tau=5+tff=0+trc=6+tsk=0+lossrt=4+idle=*_{seed}_imagenette_trained_all" / "test_data.csv",
            seed=SEED,
            experiment=['response'])

rule feedback:
    input:
        expand(project_paths.reports / "{experiment}" / "{experiment}_DyRCNNx8:tsteps=30+rctype=full+rctarget=output+dt=2+tau=5+tff=0+trc=6+tsk=0+tfb=30+feedback=*+lossrt=4_{seed}_imagenette_trained_all" / "test_data.csv",
            seed=SEED,
            experiment=['response', 'responseffonly'])

rule skip:
    input:
        expand(project_paths.reports / "{experiment}" / "{experiment}_DyRCNNx8:tsteps=20+rctype=full+rctarget=output+dt=2+tau=5+tff=0+trc=6+tsk=0+skip=*+lossrt=4_{seed}_imagenette_trained_all" / "test_data.csv",
            seed=SEED,
            experiment=['response', 'responseffonly'])

rule tsteps:
    input:
        expand(project_paths.reports / "{experiment}" / "{experiment}_DyRCNNx8:tsteps=*+rctype=full+rctarget=output+dt=2+tau=5+tff=0+trc=6+tsk=0+lossrt=4_{seed}_imagenette_trained_all" / "test_data.csv",
            seed=SEED,
            experiment=['response'])

rule lossrt:
    input:
        expand(project_paths.figures / "{experiment}" / "{experiment}_DyRCNNx8:tsteps=20+rctype=full+rctarget=output+dt=2+tau=5+tff=0+trc=6+tsk=0+skip=true+lossrt=*_{seed}_imagenette_trained_all" / "responses.png",
        seed=SEED,
        experiment=['response', 'stability'])

rule rctarget:
    input:
        expand(project_paths.figures / "{experiment}" / "{experiment}_DyRCNNx8:tsteps=20+rctype=full+rctarget=*+dt=2+tau=5+tff=0+trc=6+tsk=0+lossrt=4_{seed}_imagenette_trained_all" / "responses.png",
        seed=SEED,
        experiment=['response', 'responseffonly'])

rule rctype:
    input:
        expand(project_paths.figures / "{experiment}" / "{experiment}_DyRCNNx8:tsteps=20+rctype=*+rctarget=output+dt=2+tau=5+tff=0+trc=6+tsk=0+lossrt=4_{seed}_imagenette_trained_all" / "responses.png",
        seed=SEED,
        experiment=['response', 'duration', 'contrast', 'interval', 'responseffonly', 'uniformnoise', 'poissonnoise', 'saltpeppernoise', 'gaussianblurnoise'])

rule timeparams:
    input:
        expand(project_paths.figures / "{experiment}" / "{experiment}_DyRCNNx8:tsteps=20+rctype=full+dt=2+tau=*+tff=0+trc=6+tsk=0+lossrt=4_{seed}_imagenette_trained_all" / "responses.png",
        seed=SEED,
        experiment=['response']),
        expand(project_paths.figures / "{experiment}" / "{experiment}_DyRCNNx8:tsteps=20+rctype=full+dt=2+tau=5+tff=0+trc=*+tsk=0+lossrt=4_{seed}_imagenette_trained_all" / "responses.png",
        seed=SEED,
        experiment=['response']),
        expand(project_paths.figures / "{experiment}" / "{experiment}_DyRCNNx8:tsteps=20+rctype=full+dt=2+tau=5+tff=0+trc=6+tsk=*+lossrt=4_{seed}_imagenette_trained_all" / "responses.png",
        seed=SEED,
        experiment=['response'])


rule imagenet:
    input:
        expand(project_paths.models / "DyRCNNx8" / "DyRCNNx8:tsteps=10+rctype=full+dt=2+tau=5+tff=0+trc=6+tsk=0+lossrt=4_{seed}_imagenet_trained.pt",
        seed=SEED,
        )

rule unrolling:
    input:
        expand(project_paths.models / "DyRCNNx8" / "DyRCNNx8:tsteps=40+rctype=full+dt=2+tau=9+tff=10+trc=6+tsk=20+tfb=14+skip=true+feedback=true_{seed}_imagenette_trained.pt",
        seed="0029"),
        expand(project_paths.models / "DyRCNNx8" / "DyRCNNx8:tsteps=40+rctype=full+dt=2+tau=9+tff=0+trc=6+tsk=0+tfb=34+skip=true+feedback=true_{seed}_imagenette_trained.pt",
        seed="0030")

rule dataloader:
    input:
        # project_paths.figures / 'response' / 'response_DyRCNNx8:tsteps=20+dataloader=*+dsteps=1_0031_imagenette_trained_all' / 'response.png',
        # project_paths.figures / 'response' / 'response_DyRCNNx8:tsteps=1+dataloader=*+dsteps=20_0031_imagenette_trained_all' / 'response.png',
        project_paths.figures / 'response' / 'response_DyRCNNx8:tsteps=20+dloader=*+dsteps=1_0031_imagenette_trained#minval_all' / 'response.png',
        project_paths.figures / 'response' / 'response_DyRCNNx8:tsteps=1+dloader=*+dsteps=20_0031_imagenette_trained#minval_all' / 'response.png',

# "/home/rg5022/rhythmic_visual_attention/reports/figures/response/response_DyRCNNx8:tsteps=1+dataloader=ffcv+dsteps=20_0031_imagenette_trained_all/response.png --allowed-rules test_model process_test_data plot_response --config n_timesteps=1 use_ffcv=True data_timesteps=20 batch_size=64 num_workers=2",

# "/home/rg5022/rhythmic_visual_attention/reports/figures/response/response_DyRCNNx8:tsteps=20+dataloader=torch+dsteps=1_0031_imagenette_trained_all/response.png --allowed-rules test_model process_test_data plot_response --config n_timesteps=20 use_ffcv=False data_timesteps=1 batch_size=64 num_workers=2",

# "/home/rg5022/rhythmic_visual_attention/reports/figures/response/response_DyRCNNx8:tsteps=1+dataloader=torch+dsteps=20_0031_imagenette_trained_all/response.png --allowed-rules test_model process_test_data plot_response --config n_timesteps=1 use_ffcv=False data_timesteps=20 batch_size=64 num_workers=2",

# /scratch/rg5022/rhythmic_visual_attention/modelsDyRCNNx8/DyRCNNx8:tsteps=1+dataloader=torch+dsteps=20_0031_imagenette_trained#minval.pt"