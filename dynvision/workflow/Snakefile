include: "snake_utils.smk"
include: "snake_data.smk"
include: "snake_runtime.smk"
include: "snake_visualizations.smk"
include: "snake_experiments.smk"

rule all:
    input:
        expand(project_paths.reports / 'experiment_{experiment}.done',
            experiment = config.experiment)

SEED = "0026"

# dataloader comparison
rule test_performance:
    input:
        # lossrt
        expand(project_paths.figures / "{experiment}" / "{experiment}_DyRCNNx8:tsteps=10+rctype=full+dt=2+tau=9+tff=0+trc=6+skip=true+lossrt=*_{seed}_imagenette_trained_all" / "test_performance.png",
            seed=SEED,
            experiment=['response']),
        # rctarget
        expand(project_paths.figures / "{experiment}" / "{experiment}_DyRCNNx8:tsteps=20+rctype=full+rctarget=*+dt=2+tau=9+tff=0+trc=6+skip=true_{seed}_imagenette_trained_all" / "test_performance.png",
            seed=SEED,
            experiment=['response', 'responseffonly']),
        # recurrence type
        expand(project_paths.figures / "{experiment}" / "{experiment}_DyRCNNx8:tsteps=20+rctype=*+dt=2+tau=9+tff=0+trc=6+skip=true_{seed}_imagenette_trained_all" / "test_performance.png",
            seed=SEED,
            experiment=['duration', 'contrast', 'interval', 'response', 'responseffonly']),
        # time params
        expand(project_paths.figures / "{experiment}" / "{experiment}_DyRCNNx8:tsteps=20+rctype=full+dt=2+tau=*+tff=0+trc=6+tsk=4+skip=true_{seed}_imagenette_trained_all" / "test_performance.png",
            seed=SEED,
            experiment=['duration', 'contrast', 'interval', 'response', 'responseffonly']),
        expand(project_paths.figures / "{experiment}" / "{experiment}_DyRCNNx8:tsteps=20+rctype=full+dt=2+tau=9+tff=0+trc=*+tsk=4+skip=true_{seed}_imagenette_trained_all" / "test_performance.png",
            seed=SEED,
            experiment=['duration', 'contrast', 'interval', 'response', 'responseffonly']),
        expand(project_paths.figures / "{experiment}" / "{experiment}_DyRCNNx8:tsteps=20+rctype=full+dt=2+tau=9+tff=0+trc=6+tsk=*+skip=true_{seed}_imagenette_trained_all" / "test_performance.png",
            seed=SEED,
            experiment=["response"]),
        # feedback

rule biostability:
    input:
        expand(project_paths.figures / "{experiment}" / "{experiment}_DyRCNNx8:tsteps=20+rctype=full+rctarget=*+dt=2+tau=9+tff=0+trc=6+skip=true+lossrt={lossrt}_{seed}_imagenette_trained_all" / "response.png",
        seed="0030",
        # rctarget=['input', 'middle', 'output'],
        lossrt='10',
        experiment=['response', 'stability'])

rule lossrt:
    input:
        expand(project_paths.figures / "{experiment}" / "{experiment}_DyRCNNx8:tsteps=10+rctype=full+dt=2+tau=9+tff=0+trc=6+skip=true+lossrt=*_{seed}_imagenette_trained_all" / "response.png",
        seed=SEED,
        experiment=['response'])

rule imagenet:
    input:
        expand(project_paths.models / "DyRCNNx8" / "DyRCNNx8:tsteps=14+rctype=full+dt=2+tau=9+tff=0+trc=6+skip=true_{seed}_imagenet_trained.pt",
        seed="0030",
        )

rule feedback:
    input:
        expand(project_paths.figures / "{experiment}" / "{experiment}_DyRCNNx8:tsteps=50+rctype=full+dt=2+tau=9+tff=0+trc=6+tsk=0+tfb=34+skip=true+feedback=*_{seed}_imagenette_trained_all" / "response.png",
        seed="0030",
        experiment=["response", 'responseffonly'])

rule unrolling:
    input:
        expand(project_paths.models / "DyRCNNx8" / "DyRCNNx8:tsteps=40+rctype=full+dt=2+tau=9+tff=10+trc=6+tsk=20+tfb=14+skip=true+feedback=true_{seed}_imagenette_trained.pt",
        seed="0029"),
        expand(project_paths.models / "DyRCNNx8" / "DyRCNNx8:tsteps=40+rctype=full+dt=2+tau=9+tff=0+trc=6+tsk=0+tfb=34+skip=true+feedback=true_{seed}_imagenette_trained.pt",
        seed="0030")

rule recurrence:
    input:
        expand(project_paths.figures / "{experiment}" / "{experiment}_DyRCNNx8:tsteps=20+rctype=*+dt=2+tau=9+tff=0+trc=6+skip=true_{seed}_imagenette_trained_all" / "test_performance.png",
        seed=SEED,
        experiment=['uniformnoise', 'poissonnoise', 'saltpeppernoise', 'gaussianblurnoise', 'motionblurnoise'])
        # experiment=['duration', 'contrast', 'interval', 'response', 'responseffonly']

rule rctarget:
    input:
        expand(project_paths.figures / "{experiment}" / "{experiment}_DyRCNNx8:tsteps=20+rctype=full+rctarget=*+dt=2+tau=9+tff=0+trc=6+skip=true_{seed}_imagenette_trained_all" / "response.png",
        seed=SEED,
        experiment=['response', 'responseffonly'])

rule timeparams:
    input:
        expand(project_paths.figures / "{experiment}" / "{experiment}_DyRCNNx8:tsteps=20+rctype=full+dt=2+tau=*+tff=0+trc=6+tsk=4+skip=true_{seed}_imagenette_trained_all" / "response.png",
        seed=SEED,
        experiment=['duration', 'contrast', 'interval', 'response', 'responseffonly']),
        expand(project_paths.figures / "{experiment}" / "{experiment}_DyRCNNx8:tsteps=20+rctype=full+dt=2+tau=9+tff=0+trc=*+tsk=4+skip=true_{seed}_imagenette_trained_all" / "response.png",
        seed=SEED,
        experiment=['duration', 'contrast', 'interval', 'response', 'responseffonly']),
        expand(project_paths.figures / "{experiment}" / "{experiment}_DyRCNNx8:tsteps=20+rctype=full+dt=2+tau=9+tff=0+trc=6+tsk=*+skip=true_{seed}_imagenette_trained_all" / "response.png",
        seed=SEED,
        experiment=["response"]),

rule checkpoint:
    input:
        a = project_paths.models / "DyRCNNx8" / "DyRCNNx8:tsteps=20+rctype=depthpointwise+dt=2+tau=9+tff=0+trc=6+skip=true_0026_imagenette_trained.ckpt2pt",
        b = project_paths.models / "DyRCNNx8" / "DyRCNNx8:tsteps=40+rctype=full+dt=2+tau=9+tff=10+trc=6+tsk=16+tfb=16+skip=true+feedback=true_0026_imagenette_trained.ckpt2pt",
        c = project_paths.models / "DyRCNNx8" / "DyRCNNx8:tsteps=40+rctype=full+dt=2+tau=9+tff=10+trc=6+tsk=16+tfb=16+skip=true+feedback=false_0026_imagenette_trained.ckpt2pt",
        d = project_paths.models / "DyRCNNx8" / "DyRCNNx8:tsteps=40+rctype=full+dt=2+tau=9+tff=10+trc=6+tsk=16+tfb=16+skip=true+feedback=true+fbmode=multiplicative_0026_imagenette_trained.ckpt2pt",
